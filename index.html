<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>For WQC | Bright Christmas</title>
    <style>
        :root { --neon-gold: #ffd700; --neon-green: #00ff9d; }
        
        /* 1. èƒŒæ™¯å¤§æ”¹ï¼šåœ£è¯èŠ‚æ—¥æ¸å˜ (ä¸­å¿ƒçº¢ -> è¾¹ç¼˜ç»¿) */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; 
            /* ä½¿ç”¨å¾„å‘æ¸å˜æ¨¡æ‹Ÿæ°›å›´ç¯ */
            background: radial-gradient(circle at 50% 40%, #5e0f12 0%, #2d4a22 60%, #0d1f0d 100%);
            overflow: hidden; font-family: -apple-system, sans-serif; user-select: none; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }
        
        .header-panel { 
            pointer-events: auto; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); 
            padding: 15px 25px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.3); 
            display: inline-block; margin-top: 10px; text-align: left;
            box-shadow: 0 4px 30px rgba(0,0,0,0.3);
        }
        h1 { margin: 0; font-size: 2.2rem; font-weight: 800; letter-spacing: 1px; color: #fff; text-shadow: 0 0 10px rgba(255,215,0,0.5); }

        .actions { pointer-events: auto; display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn { 
            background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4); 
            color: white; padding: 12px 24px; border-radius: 30px; cursor: pointer; 
            font-size: 0.9rem; font-weight: 700; transition: all 0.2s ease; 
            backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn:active { transform: scale(0.95); background: rgba(255, 215, 0, 0.4); }
        .btn.primary { background: rgba(255, 215, 0, 0.2); border-color: var(--neon-gold); color: var(--neon-gold); }

        #loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f2210; z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loading-text { color: var(--neon-gold); font-family: monospace; letter-spacing: 3px; font-size: 1.2rem; margin-bottom: 10px; font-weight: bold; }
        .progress-bar { width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .progress-fill { width: 50%; height: 100%; background: var(--neon-gold); animation: loadAnim 2s infinite ease-in-out; }

        #error-log { position: absolute; top: 0; left: 0; width: 100%; background: rgba(255,0,0,0.8); color: white; padding: 10px; font-size: 12px; z-index: 1000; display: none; }
        @keyframes loadAnim { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    </style>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
            "three": "https://esm.sh/three@0.160.0",
            "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.12?external=react,react-dom,three",
            "@react-three/drei": "https://esm.sh/@react-three/drei@9.96.1?external=react,react-dom,three,@react-three/fiber",
            "@react-three/postprocessing": "https://esm.sh/@react-three/postprocessing@2.16.0?external=react,react-dom,three,@react-three/fiber",
            "uuid": "https://esm.sh/uuid@9.0.1"
        }
    }
    </script>
</head>
<body>
    <div id="error-log"></div>
    <div id="loader">
        <div class="loading-text">MERRY CHRISTMAS</div>
        <div class="progress-bar"><div class="progress-fill"></div></div>
    </div>

    <div id="ui-layer">
        <div class="header-panel">
            <h1>TO WQC</h1>
        </div>
        <div class="actions">
            <div id="btn-play" class="btn primary">â–¶ PLAY MUSIC</div>
            <div id="btn-remix" class="btn">ğŸ¨ REMIX</div>
            <div id="btn-morph" class="btn">âœ¨ SHAPE</div>
            <div id="btn-snap" class="btn">ğŸ“· SAVE</div>
        </div>
    </div>
    
    <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%"></div>

    <script>
        window.onerror = function(msg, url, line) {
            const el = document.getElementById('error-log');
            el.style.display = 'block';
            el.innerHTML += `Error: ${msg} <br>`;
            document.getElementById('loader').style.display = 'none';
        };
        setTimeout(() => {
            const l = document.getElementById('loader');
            if(l && l.style.display !== 'none') {
                l.style.opacity = 0;
                setTimeout(()=>l.style.display='none', 500);
            }
        }, 10000); 
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useRef, useEffect, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree } from '@react-three/fiber';
        import { OrbitControls, Text3D, Center, Float, Sparkles } from '@react-three/drei';
        import { EffectComposer, Bloom, Vignette } from '@react-three/postprocessing';

        // --- Audio Engine ---
        class AudioEngine {
            constructor() { 
                this.ctx = null; 
                this.analyser = null; 
                this.dataArray = null;
                this.nextNoteTime = 0;
                this.timerID = null;
                this.notes = [
                    {f:659,d:0.2},{f:659,d:0.2},{f:659,d:0.4}, // Jingle
                    {f:659,d:0.2},{f:659,d:0.2},{f:659,d:0.4}, // Bells
                    {f:659,d:0.2},{f:783,d:0.2},{f:523,d:0.2},{f:587,d:0.2},{f:659,d:0.8}, // All the way
                    {f:587,d:0.2},{f:587,d:0.2},{f:659,d:0.2},{f:587,d:0.2},{f:783,d:0.4} // Fun ending
                ];
                this.currentNoteIndex = 0;
            }
            init() {
                if (this.ctx) return;
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 64; 
                this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
            }
            scheduler() {
                while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
                    this.playNote(this.notes[this.currentNoteIndex], this.nextNoteTime);
                    this.nextNoteTime += this.notes[this.currentNoteIndex].d * 0.45;
                    this.currentNoteIndex++;
                    if (this.currentNoteIndex >= this.notes.length) {
                        this.currentNoteIndex = 0; 
                        this.nextNoteTime += 0.5; 
                    }
                }
                this.timerID = window.setTimeout(this.scheduler.bind(this), 25);
            }
            playNote(note, time) {
                if(note.f === 0) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle'; osc.frequency.value = note.f;
                osc.connect(gain); gain.connect(this.analyser); this.analyser.connect(this.ctx.destination);
                osc.start(time);
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.15, time + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, time + note.d * 0.9);
                osc.stop(time + note.d);
            }
            toggle() {
                if (!this.ctx) {
                    this.init();
                    this.nextNoteTime = this.ctx.currentTime + 0.1;
                    this.scheduler();
                    return true;
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                    return true;
                } else {
                    this.ctx.suspend();
                    return false;
                }
            }
            getEnergy() {
                if (!this.analyser) return 0;
                this.analyser.getByteFrequencyData(this.dataArray);
                let sum = 0; for(let i=0; i<6; i++) sum += this.dataArray[i];
                return sum / 6 / 255; 
            }
        }
        const audioSystem = new AudioEngine();

        // --- CatVoxels (æ ‘/ç²’å­) ---
        const CatVoxels = ({ count = 2000, colors, mode, isPlaying }) => {
            const meshRef = useRef();
            const dummy = useMemo(() => new THREE.Object3D(), []);
            
            const particles = useMemo(() => {
                const temp = [];
                for (let i = 0; i < count; i++) {
                    const t = i / count;
                    const angle = t * Math.PI * 25;
                    const radius = (1 - t) * 15;
                    const y = t * 40 - 20;
                    const treePos = new THREE.Vector3(Math.cos(angle)*radius, y, Math.sin(angle)*radius);
                    const scatterPos = new THREE.Vector3((Math.random()-0.5)*80, (Math.random()-0.5)*60, (Math.random()-0.5)*80);
                    temp.push({ treePos, scatterPos, pos: scatterPos.clone(), speed: Math.random()*0.5+0.5, phase: Math.random()*Math.PI*2, colorType: Math.random() });
                }
                return temp;
            }, [count]);

            useEffect(() => {
                if(!meshRef.current) return;
                particles.forEach((p, i) => {
                    const c = p.colorType<0.3?colors[0]:(p.colorType<0.6?colors[1]:colors[2]);
                    meshRef.current.setColorAt(i, c);
                });
                meshRef.current.instanceColor.needsUpdate = true;
            }, [colors]);

            useFrame((state, delta) => {
                if(!meshRef.current) return;
                const energy = audioSystem.getEnergy();
                const time = state.clock.elapsedTime;
                const isTree = mode === 'TREE';
                const pulse = isPlaying ? (1 + energy * 0.5) : 1;

                particles.forEach((p, i) => {
                    const targetBase = isTree ? p.treePos : p.scatterPos;
                    let target = targetBase.clone();
                    if(isTree) {
                        target.applyAxisAngle(new THREE.Vector3(0,1,0), time * 0.2);
                        target.multiplyScalar(pulse);
                    }
                    p.pos.lerp(target, delta * 2.5 * p.speed);
                    
                    let bounce = 0;
                    if(isTree && isPlaying) {
                        bounce = Math.sin(time * 12 + p.phase) * (0.2 + energy * 5);
                    }
                    
                    dummy.position.copy(p.pos); dummy.position.y += bounce;
                    dummy.lookAt(0, p.pos.y, 0); 
                    dummy.scale.setScalar(0.4 * (isPlaying ? (1 + energy * 0.3) : 1)); 
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                });
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            return (
                <instancedMesh ref={meshRef} args={[null, null, count]}>
                    <boxGeometry args={[1, 0.8, 1]} />
                    {/* æè´¨ä¼˜åŒ–ï¼šå‡å°‘é‡‘å±æ„Ÿï¼Œå¢åŠ ç²—ç³™åº¦ï¼Œè®©å®ƒåƒå‘å…‰çš„ç§¯æœ¨ï¼Œæ›´äº® */}
                    <meshStandardMaterial roughness={0.2} metalness={0.1} emissive="#222" emissiveIntensity={0.2} />
                </instancedMesh>
            );
        };

        const Scene = ({ colors, mode, setMode }) => {
            const [playing, setPlaying] = useState(false);
            
            useEffect(() => {
                const btnPlay = document.getElementById('btn-play');
                const btnRemix = document.getElementById('btn-remix');
                const btnSnap = document.getElementById('btn-snap');
                const btnMorph = document.getElementById('btn-morph');

                btnPlay.onclick = () => { 
                    const isNowPlaying = audioSystem.toggle();
                    setPlaying(isNowPlaying);
                    if(isNowPlaying) {
                        btnPlay.innerText = "â¸ PAUSE";
                        btnPlay.classList.remove('primary');
                    } else {
                        btnPlay.innerText = "â–¶ PLAY MUSIC";
                        btnPlay.classList.add('primary');
                    }
                };
                btnRemix.onclick = () => window.changeColors(); 
                btnMorph.onclick = () => setMode(prev => prev==='TREE'?'SCATTER':'TREE');
                btnSnap.onclick = () => {
                    const canvas = document.querySelector('canvas');
                    const link = document.createElement('a'); link.download = 'WQC-Christmas.png'; link.href = canvas.toDataURL('image/png'); link.click();
                };
            }, []);

            return (
                <>
                    {/* === 2. ç»ˆæç¯å…‰ç³»ç»Ÿï¼šå‰åå·¦å³ä¸­å…¨äº® === */}
                    
                    {/* ç¯å¢ƒå…‰ï¼šå¤§å¹…æé«˜åŸºç¡€äº®åº¦ */}
                    <ambientLight intensity={1.5} color="#ffe" />
                    
                    {/* æ­£é¢å¼ºå…‰ */}
                    <directionalLight position={[0, 0, 20]} intensity={3} color="#fff8e7" />
                    
                    {/* èƒŒé¢è¡¥å…‰ */}
                    <directionalLight position={[0, 0, -20]} intensity={2} color="#ccffcc" />
                    
                    {/* å·¦ä¾§å…‰ */}
                    <directionalLight position={[-20, 0, 0]} intensity={2} color="#ffddee" />
                    
                    {/* å³ä¾§å…‰ */}
                    <directionalLight position={[20, 0, 0]} intensity={2} color="#ddeeff" />
                    
                    {/* é¡¶éƒ¨å¼ºå…‰ */}
                    <spotLight position={[0, 50, 0]} intensity={50} angle={0.6} color={colors[0]} penumbra={0.5} />
                    
                    {/* æ ¸å¿ƒå†…å‘å…‰ (è®©æ ‘çœ‹èµ·æ¥é€šé€) */}
                    <pointLight position={[0, 10, 0]} intensity={10} distance={30} color="#ffaa00" />
                    
                    <CatVoxels count={2200} colors={colors} mode={mode} isPlaying={playing} />
                    
                    {/* é›ªèŠ±ç²’å­ï¼šåŠ å¤§æ•°é‡ï¼Œè¦†ç›–å…¨å± */}
                    <Sparkles count={800} scale={[100, 100, 100]} size={6} speed={0.4} opacity={0.9} color="#fff" />
                    
                    <group position={[0, -25, 0]}>
                        <Float speed={2} rotationIntensity={0.5} floatIntensity={0.5}>
                            <Center>
                                <Text3D 
                                    font="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json"
                                    size={4} height={0.5} curveSegments={12} bevelEnabled bevelThickness={0.1}
                                >
                                    TO WQC
                                    <meshStandardMaterial color={colors[0]} emissive={colors[0]} emissiveIntensity={0.8} />
                                </Text3D>
                            </Center>
                        </Float>
                    </group>

                    <EffectComposer disableNormalPass>
                        <Bloom luminanceThreshold={0.6} mipmapBlur intensity={1.2} radius={0.5} />
                        <Vignette eskil={false} offset={0.1} darkness={0.8} />
                    </EffectComposer>
                </>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('TREE');
            const [colors, setColors] = useState([new THREE.Color('#FFD700'), new THREE.Color('#00FF9D'), new THREE.Color('#FF0080')]);
            
            useEffect(() => {
                window.changeColors = () => {
                    setColors([
                        new THREE.Color('#'+Math.floor(Math.random()*16777215).toString(16)),
                        new THREE.Color('#'+Math.floor(Math.random()*16777215).toString(16)),
                        new THREE.Color('#'+Math.floor(Math.random()*16777215).toString(16))
                    ]);
                };
                const l = document.getElementById('loader');
                if(l) setTimeout(() => { l.style.opacity = 0; setTimeout(()=>l.style.display='none', 500); }, 2000);
            }, []);

            return (
                <Canvas dpr={[1, 1.5]} gl={{ antialias: false, toneMapping: THREE.ACESFilmicToneMapping }} camera={{ position: [0, 0, 60], fov: 45 }}>
                    <Suspense fallback={null}>
                        <Scene colors={colors} mode={mode} setMode={setMode} />
                    </Suspense>
                    <OrbitControls enablePan={false} maxDistance={90} minDistance={20} autoRotate={true} autoRotateSpeed={0.5} />
                </Canvas>
            );
        };

        const root = createRoot(document.getElementById('canvas-container'));
        root.render(<App />);
    </script>
</body>
</html>
